<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Consent-Based Text Logger</title>
  <style>
    body { font-family: system-ui, -apple-system, Roboto, Arial; max-width:900px; margin:2rem auto; padding:0 1rem; }
    h1 { margin-bottom: .2rem; }
    form { display:flex; gap:.5rem; margin-bottom:1rem; align-items:flex-start; }
    input[type="text"], textarea { width:100%; padding:.5rem; border-radius:6px; border:1px solid #ccc; font-size:1rem; }
    button { padding:.5rem .8rem; border-radius:6px; border:1px solid #888; background:#f3f3f3; cursor:pointer; }
    .controls { display:flex; gap:.5rem; margin-bottom:1rem; }
    .entry { padding:.5rem; border-bottom:1px solid #eee; }
    .meta { color:#666; font-size:.85rem; margin-bottom:.25rem; }
    .danger { color:#a00; }
  </style>
</head>
<body>
  <h1>Consent-Based Text Logger</h1>
  <p>
    This page only records text that the user explicitly <strong>submits</strong>.
    It does <em>not</em> capture keystrokes or activity outside this page. Use only with clear consent.
  </p>

  <form id="inputForm">
    <div style="flex:1">
      <label for="name">Name (optional)</label><br />
      <input id="name" name="name" type="text" placeholder="Your name" />
      <label for="message" style="display:block; margin-top:.5rem">Message</label>
      <textarea id="message" name="message" rows="4" placeholder="Type something and click Submit..." required></textarea>
    </div>
    <div style="width:140px; display:flex; flex-direction:column; gap:.5rem; margin-left:.5rem;">
      <button type="submit">Submit</button>
      <button id="clearForm" type="button">Clear fields</button>
    </div>
  </form>

  <div class="controls">
    <button id="exportCsv" type="button">Export CSV</button>
    <button id="clearStorage" type="button">Clear saved entries</button>
    <div style="margin-left:auto; font-size:.9rem; color:#333;">
      Entries stored: <span id="count">0</span>
    </div>
  </div>

  <div id="entries"></div>

  <script>
    // Simple consent prompt before enabling save
    const storageKey = 'consent_text_logger_entries_v1';
    let entries = [];

    function load() {
      try {
        const raw = localStorage.getItem(storageKey);
        entries = raw ? JSON.parse(raw) : [];
      } catch(e) {
        entries = [];
      }
      renderEntries();
    }

    function save() {
      localStorage.setItem(storageKey, JSON.stringify(entries));
      document.getElementById('count').textContent = entries.length;
    }

    function renderEntries() {
      const container = document.getElementById('entries');
      container.innerHTML = '';
      if (entries.length === 0) {
        container.innerHTML = '<p><em>No entries yet.</em></p>';
        document.getElementById('count').textContent = 0;
        return;
      }
      entries.slice().reverse().forEach(e => {
        const div = document.createElement('div');
        div.className = 'entry';
        const meta = document.createElement('div');
        meta.className = 'meta';
        meta.textContent = `${e.name ? e.name + ' â€” ' : ''}${new Date(e.time).toLocaleString()}`;
        const msg = document.createElement('div');
        msg.textContent = e.message;
        div.appendChild(meta);
        div.appendChild(msg);
        container.appendChild(div);
      });
      document.getElementById('count').textContent = entries.length;
    }

    document.getElementById('inputForm').addEventListener('submit', (ev) => {
      ev.preventDefault();
      // simple consent check
      if (!localStorage.getItem('consent_text_logger_allowed')) {
        const allow = confirm('Do you consent to having the text you submit stored locally in this browser? (Only stored locally.)');
        if (!allow) return;
        localStorage.setItem('consent_text_logger_allowed', '1');
      }

      const name = document.getElementById('name').value.trim();
      const message = document.getElementById('message').value.trim();
      if (!message) return;

      const entry = { name, message, time: new Date().toISOString() };
      entries.push(entry);
      save();
      renderEntries();

      // clear message field (keep name)
      document.getElementById('message').value = '';
    });

    document.getElementById('clearForm').addEventListener('click', () => {
      document.getElementById('name').value = '';
      document.getElementById('message').value = '';
    });

    document.getElementById('clearStorage').addEventListener('click', () => {
      if (!confirm('Clear all saved entries from this browser?')) return;
      entries = [];
      save();
      renderEntries();
    });

    document.getElementById('exportCsv').addEventListener('click', () => {
      if (entries.length === 0) { alert('No entries to export'); return; }
      // build CSV
      let csv = 'name,time,message\\n';
      entries.forEach(e => {
        // basic escaping
        const esc = s => '"' + String(s).replace(/"/g, '""') + '"';
        csv += [esc(e.name), esc(e.time), esc(e.message)].join(',') + '\\n';
      });
      // download
      const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'entries.csv';
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    });

    // initialize
    load();
  </script>
</body>
</html>