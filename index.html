<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Digimon Battle ‚Äî Evolve In-Battle</title>
<style>
  :root{
    --bg:#0f1724; --panel:#0b1220; --accent:#0ea5a4; --muted:#94a3b8;
  }
  *{box-sizing:border-box; font-family:Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;}
  body{margin:0; background:linear-gradient(180deg,#071023 0%,#0f1724 100%); color:#e6eef6; min-height:100vh; display:flex; align-items:center; justify-content:center; padding:20px;}
  .wrap{width:980px; max-width:98%; background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01)); border-radius:12px; box-shadow:0 10px 30px rgba(2,6,23,0.7); padding:18px; display:grid; grid-template-columns:1fr 380px; gap:14px;}
  .arena{background:var(--panel); padding:14px; border-radius:10px; display:flex; flex-direction:column; gap:12px;}
  .status-row{display:flex; gap:12px; align-items:center;}
  .digimon-card{flex:1; background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.0)); border-radius:10px; padding:10px; display:flex; gap:10px; align-items:center; border:1px solid rgba(255,255,255,0.03);}
  .sprite{width:88px; height:88px; border-radius:8px; display:flex; align-items:center; justify-content:center; font-size:48px; background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01)); box-shadow: inset 0 -6px 14px rgba(0,0,0,0.6);}
  .info{flex:1;}
  .name{font-weight:700; font-size:18px;}
  .stage{font-size:12px; color:var(--muted);}
  .hpbar{height:10px; background:rgba(255,255,255,0.06); border-radius:8px; overflow:hidden; margin-top:8px;}
  .hpfill{height:100%; background:linear-gradient(90deg,#ef4444,#fb923c); width:100%; transition:width .4s ease;}
  .meter{height:8px; background:rgba(255,255,255,0.03); border-radius:8px; overflow:hidden; margin-top:8px;}
  .meterfill{height:100%; background:linear-gradient(90deg,var(--accent),#60a5fa); width:0%; transition:width .5s ease;}
  .log{height:220px; background:rgba(255,255,255,0.02); border-radius:8px; padding:10px; overflow:auto; font-size:13px; border:1px solid rgba(255,255,255,0.03);}
  .controls{display:flex; flex-direction:column; gap:10px;}
  .btn{background:linear-gradient(180deg,#0ea5a4,#0891b2); border:none; color:white; padding:10px 14px; border-radius:8px; cursor:pointer; font-weight:600;}
  .btn:active{transform:translateY(1px);}
  .btn.secondary{background:transparent; border:1px solid rgba(255,255,255,0.06); color:var(--muted); font-weight:700;}
  .right{background:var(--panel); padding:14px; border-radius:10px; display:flex; flex-direction:column; gap:12px; border:1px solid rgba(255,255,255,0.03);}
  .center{display:flex; align-items:center; justify-content:center; gap:12px;}
  .big-emoji{font-size:64px; transition:transform .35s ease;}
  .big-emoji.evolve{transform:scale(1.25) rotate(-6deg);}
  .stats{display:grid; grid-template-columns:repeat(3,1fr); gap:8px;}
  .stat{background:rgba(255,255,255,0.01); padding:8px; border-radius:8px; text-align:center; font-size:13px;}
  footer{font-size:12px; color:var(--muted); text-align:center; margin-top:6px;}
  @media (max-width:900px){ .wrap{grid-template-columns:1fr; } .right{order:-1;} }
</style>
</head>
<body>
  <div class="wrap" role="application" aria-label="Digimon battle simulator">
    <div class="arena">
      <div class="status-row">
        <div class="digimon-card" id="playerCard">
          <div class="sprite" id="playerSprite">üê£</div>
          <div class="info">
            <div><span class="name" id="playerName">Piyo</span> <span class="stage" id="playerStage">Baby</span></div>
            <div class="hpbar" title="HP"><div class="hpfill" id="playerHPFill" style="width:100%"></div></div>
            <div style="display:flex; gap:8px; margin-top:6px; align-items:center;"><small class="stage">HP</small><div style="flex:1; text-align:right;"><small id="playerHPText">40 / 40</small></div></div>
            <div class="meter" title="Evolution Meter"><div class="meterfill" id="playerMeter" style="width:0%"></div></div>
          </div>
        </div>

        <div class="digimon-card" id="enemyCard">
          <div class="sprite" id="enemySprite">üê≤</div>
          <div class="info">
            <div><span class="name" id="enemyName">Drako</span> <span class="stage" id="enemyStage">Rookie</span></div>
            <div class="hpbar" title="HP"><div class="hpfill" id="enemyHPFill" style="width:100%"></div></div>
            <div style="display:flex; gap:8px; margin-top:6px; align-items:center;"><small class="stage">HP</small><div style="flex:1; text-align:right;"><small id="enemyHPText">55 / 55</small></div></div>
            <div class="meter" title="Evolution Meter"><div class="meterfill" id="enemyMeter" style="width:0%"></div></div>
          </div>
        </div>
      </div>

      <div class="center">
        <div style="text-align:center; width:100%;">
          <div class="big-emoji" id="battleCenter">‚öîÔ∏è</div>
          <div style="margin-top:8px; color:var(--muted); font-size:13px;">Turn-based battle ‚Äî evolve mid-battle to increase stats and unlock moves</div>
        </div>
      </div>

      <div class="log" id="battleLog" aria-live="polite"></div>
    </div>

    <div class="right">
      <div class="controls">
        <button class="btn" id="attackBtn">Attack</button>
        <button class="btn secondary" id="guardBtn">Guard (reduce dmg)</button>
        <button class="btn" id="evolveBtn">Evolve (use meter)</button>
        <button class="btn secondary" id="resetBtn">Reset Battle</button>
      </div>

      <div>
        <div style="display:flex; justify-content:space-between; align-items:center;">
          <strong>Player Stats</strong><small class="stage" id="pExtra">Atk: ‚Äî Def: ‚Äî</small>
        </div>
        <div class="stats" id="playerStats">
          <div class="stat">Attack: <div id="pAtk">‚Äî</div></div>
          <div class="stat">Defense: <div id="pDef">‚Äî</div></div>
          <div class="stat">Speed: <div id="pSpd">‚Äî</div></div>
        </div>
      </div>

      <div>
        <div style="display:flex; justify-content:space-between; align-items:center;">
          <strong>Enemy Stats</strong><small class="stage" id="eExtra">Atk: ‚Äî Def: ‚Äî</small>
        </div>
        <div class="stats" id="enemyStats">
          <div class="stat">Attack: <div id="eAtk">‚Äî</div></div>
          <div class="stat">Defense: <div id="eDef">‚Äî</div></div>
          <div class="stat">Speed: <div id="eSpd">‚Äî</div></div>
        </div>
      </div>

      <footer>Tip: Attacking fills your evolution meter. Use <strong>Evolve</strong> mid-battle to power up instantly.</footer>
    </div>
  </div>

<script>
/*
  Simple Digimon-like battle with in-battle evolution.
  Structure: each "creature" has multiple stages. Evolution consumes meter and upgrades stats + emoji.
*/

const logEl = document.getElementById('battleLog');
const battleCenter = document.getElementById('battleCenter');

// utility
function log(...txt){ const line = document.createElement('div'); line.textContent = txt.join(' '); logEl.prepend(line); }
function clamp(v, a, b){ return Math.max(a, Math.min(b, v)); }

// define species with evolution stages
const PlayerSpecies = {
  baseName: 'Piyo',
  stages: [
    { name:'Child', emoji:'üê£', hp:40, atk:8, def:4, spd:6, meterCost:50, desc:'Small but feisty.' },
    { name:'Rookie', emoji:'üê§', hp:60, atk:12, def:6, spd:8, meterCost:80, desc:'Gaining strength.' },
    { name:'Champion', emoji:'ü¶Ö', hp:90, atk:20, def:10, spd:10, meterCost:130, desc:'Powerful flier.' },
    { name:'Ultimate', emoji:'ü¶ú', hp:130, atk:30, def:18, spd:12, meterCost:999, desc:'Formidable!' }
  ]
};

const EnemySpecies = {
  baseName: 'Drako',
  stages: [
    { name:'In-Training', emoji:'üêâ', hp:50, atk:10, def:5, spd:5, meterCost:60 },
    { name:'Rookie', emoji:'üî•', hp:70, atk:14, def:8, spd:7, meterCost:110 },
    { name:'Champion', emoji:'üê≤', hp:105, atk:22, def:12, spd:9, meterCost:999 } // enemy typically final at champion
  ]
};

// creature factory
function makeCreature(species, initialStageIndex=0){
  const stageIndex = initialStageIndex;
  const stage = species.stages[stageIndex];
  return {
    species,
    stageIndex,
    hpMax: stage.hp,
    hp: stage.hp,
    atk: stage.atk,
    def: stage.def,
    spd: stage.spd,
    name: species.baseName,
    meter: 0,
    guard: false,
    getStage(){ return this.species.stages[this.stageIndex]; },
    canEvolve(){ return this.stageIndex < this.species.stages.length -1 && this.meter >= this.species.stages[this.stageIndex+1].meterCost; },
    evolve(){
      if(!this.canEvolve()) return false;
      const next = this.species.stages[this.stageIndex+1];
      this.stageIndex++;
      // immediate stat change: increase max hp proportionally and refill relative HP
      const oldMax = this.hpMax;
      this.hpMax = next.hp;
      // keep same % HP
      const pct = this.hp / oldMax;
      this.hp = Math.round(this.hpMax * pct);
      this.atk = next.atk;
      this.def = next.def;
      this.spd = next.spd;
      // optionally reset meter to 0 or reduce
      this.meter = Math.max(0, this.meter - next.meterCost);
      return true;
    }
  };
}

// game state
let player = null;
let enemy = null;
let playerTurn = true;
let busy = false;

const ui = {
  playerSprite: document.getElementById('playerSprite'),
  playerName: document.getElementById('playerName'),
  playerStage: document.getElementById('playerStage'),
  playerHPFill: document.getElementById('playerHPFill'),
  playerHPText: document.getElementById('playerHPText'),
  playerMeter: document.getElementById('playerMeter'),
  enemySprite: document.getElementById('enemySprite'),
  enemyName: document.getElementById('enemyName'),
  enemyStage: document.getElementById('enemyStage'),
  enemyHPFill: document.getElementById('enemyHPFill'),
  enemyHPText: document.getElementById('enemyHPText'),
  enemyMeter: document.getElementById('enemyMeter'),
  pAtk: document.getElementById('pAtk'),
  pDef: document.getElementById('pDef'),
  pSpd: document.getElementById('pSpd'),
  eAtk: document.getElementById('eAtk'),
  eDef: document.getElementById('eDef'),
  eSpd: document.getElementById('eSpd'),
  pExtra: document.getElementById('pExtra'),
  eExtra: document.getElementById('eExtra'),
  evolveBtn: document.getElementById('evolveBtn'),
  attackBtn: document.getElementById('attackBtn'),
  guardBtn: document.getElementById('guardBtn'),
  resetBtn: document.getElementById('resetBtn'),
  battleCenter
};

function updateUI(){
  // player UI
  const pctP = Math.round(100 * player.hp / player.hpMax);
  ui.playerHPFill.style.width = pctP + '%';
  ui.playerHPText.textContent = `${player.hp} / ${player.hpMax}`;
  ui.playerMeter.style.width = clamp(player.meter,0,100) + '%'; // meter displayed 0-100 for UX (we'll map)
  ui.playerSprite.textContent = player.getStage().emoji;
  ui.playerName.textContent = player.name;
  ui.playerStage.textContent = player.getStage().name;
  ui.pAtk.textContent = player.atk;
  ui.pDef.textContent = player.def;
  ui.pSpd.textContent = player.spd;
  ui.pExtra.textContent = `Atk: ${player.atk} Def: ${player.def}`;

  // enemy UI
  const pctE = Math.round(100 * enemy.hp / enemy.hpMax);
  ui.enemyHPFill.style.width = pctE + '%';
  ui.enemyHPText.textContent = `${enemy.hp} / ${enemy.hpMax}`;
  ui.enemyMeter.style.width = clamp(enemy.meter,0,100) + '%';
  ui.enemySprite.textContent = enemy.getStage().emoji;
  ui.enemyName.textContent = enemy.name;
  ui.enemyStage.textContent = enemy.getStage().name;
  ui.eAtk.textContent = enemy.atk;
  ui.eDef.textContent = enemy.def;
  ui.eSpd.textContent = enemy.spd;
  ui.eExtra.textContent = `Atk: ${enemy.atk} Def: ${enemy.def}`;

  // buttons
  ui.evolveBtn.disabled = !player.canEvolve() || busy;
  ui.attackBtn.disabled = busy;
  ui.guardBtn.disabled = busy;
}

// simple damage formula
function calcDamage(attacker, defender, base=1){
  // chance to crit: small
  const crit = Math.random() < 0.08 ? 1.5 : 1.0;
  const raw = Math.max(1, Math.round((attacker.atk * base) - (defender.def * 0.5)));
  let dmg = Math.round(raw * crit * (1 + (Math.random()*0.12 - 0.06))); // small variance
  if(defender.guard) dmg = Math.round(dmg * 0.5);
  return Math.max(1, dmg);
}

function endIfOver(){
  if(player.hp <= 0 || enemy.hp <= 0){
    busy = true;
    if(player.hp <= 0 && enemy.hp <= 0){
      log("Both knocked out! It's a draw.");
    } else if(enemy.hp <= 0){
      log(`${player.name} wins!`);
    } else {
      log(`${enemy.name} wins...`);
    }
    ui.attackBtn.disabled = true;
    ui.guardBtn.disabled = true;
    ui.evolveBtn.disabled = true;
    return true;
  }
  return false;
}

// action handlers
async function playerAttack(){
  if(busy) return;
  busy = true;
  player.guard = false;
  const damage = calcDamage(player, enemy);
  enemy.hp = clamp(enemy.hp - damage, 0, enemy.hpMax);
  player.meter = Math.min(player.meter + 22, 200); // fill meter faster when attacking
  log(`${player.name} attacks for ${damage} damage!`);
  animateCenter('attack');
  updateUI();
  if(endIfOver()) return;
  await sleep(600);
  await enemyTurn();
}

async function playerGuard(){
  if(busy) return;
  busy = true;
  player.guard = true;
  player.meter = Math.min(player.meter + 8, 200);
  log(`${player.name} braces to guard (reduces incoming damage).`);
  updateUI();
  await sleep(400);
  await enemyTurn();
}

async function playerEvolve(){
  if(busy) return;
  if(!player.canEvolve()){
    log("Can't evolve yet ‚Äî meter not enough or at final stage.");
    return;
  }
  busy = true;
  const next = player.species.stages[player.stageIndex+1];
  log(`${player.name} begins evolving to ${next.name} ‚Äî ${next.desc || ''}`);
  ui.playerSprite.classList.add('evolve');
  // brief delay to emphasize
  await sleep(700);
  player.evolve();
  // small heal on evolution (5% of new max)
  player.hp = clamp(player.hp + Math.round(player.hpMax * 0.05), 0, player.hpMax);
  ui.playerSprite.classList.remove('evolve');
  log(`${player.name} evolved into ${player.getStage().name}! Stats increased.`);
  animateCenter('evolve');
  updateUI();
  await sleep(400);
  busy = false;
  // enemy may take immediate turn
  if(!endIfOver()) {
    await enemyTurn();
  }
}

// enemy AI / turn
async function enemyTurn(){
  if(endIfOver()) return;
  enemy.guard = false;
  // simple AI decisions:
  // if can evolve and random chance -> evolve
  if(enemy.canEvolve() && Math.random() < 0.45){
    // evolve
    log(`${enemy.name} is evolving...`);
    await sleep(700);
    enemy.evolve();
    enemy.hp = clamp(enemy.hp + Math.round(enemy.hpMax * 0.03), 0, enemy.hpMax);
    log(`${enemy.name} evolved to ${enemy.getStage().name}!`);
    updateUI();
    busy = false;
    return;
  }

  // else pick attack or guard based on hp
  const choose = Math.random();
  if(choose < 0.75 || enemy.hp < enemy.hpMax * 0.35){
    // attack
    const damage = calcDamage(enemy, player);
    player.hp = clamp(player.hp - damage, 0, player.hpMax);
    enemy.meter = Math.min(enemy.meter + 18, 200);
    log(`${enemy.name} hits ${player.name} for ${damage} damage.`);
    animateCenter('hit');
    updateUI();
  } else {
    // guard
    enemy.guard = true;
    enemy.meter = Math.min(enemy.meter + 10, 200);
    log(`${enemy.name} takes a defensive stance.`);
    updateUI();
  }
  busy = false;
  endIfOver();
}

// small animation helper
function animateCenter(type){
  if(type === 'attack'){
    battleCenter.textContent = '‚öîÔ∏è';
    battleCenter.classList.add('evolve');
    setTimeout(()=>battleCenter.classList.remove('evolve'),350);
  } else if(type === 'evolve'){
    battleCenter.textContent = '‚ú®';
    battleCenter.classList.add('evolve');
    setTimeout(()=>{ battleCenter.classList.remove('evolve'); battleCenter.textContent='‚öîÔ∏è'; },700);
  } else if(type === 'hit'){
    battleCenter.textContent = 'üí•';
    battleCenter.classList.add('evolve');
    setTimeout(()=>{ battleCenter.classList.remove('evolve'); battleCenter.textContent='‚öîÔ∏è'; },450);
  }
}

// helper to convert actual meter (0-200) into UI percent 0-100 (ease)
function meterToPercent(v){
  return clamp(Math.round(v / 2), 0, 100);
}

function syncMeters(){
  ui.playerMeter.style.width = meterToPercent(player.meter) + '%';
  ui.enemyMeter.style.width = meterToPercent(enemy.meter) + '%';
}

// sleep
function sleep(ms){ return new Promise(r => setTimeout(r, ms)); }

// reset / start
function startBattle(){
  player = makeCreature(PlayerSpecies, 0);
  enemy = makeCreature(EnemySpecies, 0);
  // small name examples
  player.name = "Piyo";
  enemy.name = "Drako";
  // quick randomize enemy stage sometimes
  if(Math.random() < 0.5) {
    enemy.stageIndex = 1;
    const st = enemy.getStage();
    enemy.hpMax = st.hp; enemy.hp = st.hp; enemy.atk = st.atk; enemy.def = st.def; enemy.spd = st.spd;
  }
  // reset meters
  player.meter = 0; enemy.meter = 0;
  player.guard = false; enemy.guard = false;
  playerTurn = true;
  busy = false;
  logEl.innerHTML = '';
  log("Battle Start! You vs. " + enemy.name + " (" + enemy.getStage().name + ")");
  updateUI();
  // render meter percent correctly
  syncMeters();
}

// link buttons
ui.attackBtn.addEventListener('click', async ()=>{ await playerAttack(); syncMeters(); updateUI(); });
ui.guardBtn.addEventListener('click', async ()=>{ await playerGuard(); syncMeters(); updateUI(); });
ui.evolveBtn.addEventListener('click', async ()=>{ await playerEvolve(); syncMeters(); updateUI(); });
ui.resetBtn.addEventListener('click', ()=>{ startBattle(); });

// initialize
startBattle();
</script>
</body>
</html>